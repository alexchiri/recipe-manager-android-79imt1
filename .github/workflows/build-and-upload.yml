name: Build and Upload Android APK

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      release_notes:
        description: 'Release notes (optional)'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Get current version
        id: current_version
        run: |
          VERSION_NAME=$(grep -oP 'versionName = "\K[^"]+' app/build.gradle.kts)
          VERSION_CODE=$(grep -oP 'versionCode = \K\d+' app/build.gradle.kts)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION_NAME ($VERSION_CODE)"

      - name: Calculate new version
        id: new_version
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.version_name }}"
          BUMP_TYPE="${{ github.event.inputs.bump_type }}"

          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          case $BUMP_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          NEW_VERSION_CODE=$((${{ steps.current_version.outputs.version_code }} + 1))

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_version_code=$NEW_VERSION_CODE" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION ($NEW_VERSION_CODE)"

      - name: Update version in build.gradle.kts
        run: |
          sed -i 's/versionCode = ${{ steps.current_version.outputs.version_code }}/versionCode = ${{ steps.new_version.outputs.new_version_code }}/' app/build.gradle.kts
          sed -i 's/versionName = "${{ steps.current_version.outputs.version_name }}"/versionName = "${{ steps.new_version.outputs.new_version }}"/' app/build.gradle.kts

          echo "Updated build.gradle.kts:"
          grep -E "versionCode|versionName" app/build.gradle.kts

      - name: Build Release APK
        run: ./gradlew assembleRelease --no-daemon

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/release-keystore.jks

      - name: Sign APK
        env:
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
            --ks app/release-keystore.jks \
            --ks-key-alias "$KEY_ALIAS" \
            --ks-pass "pass:$KEYSTORE_PASSWORD" \
            --key-pass "pass:$KEY_PASSWORD" \
            --out app/build/outputs/apk/release/app-release-signed.apk \
            app/build/outputs/apk/release/app-release-unsigned.apk

      - name: Upload APK to hosting service
        run: |
          NOTES="${{ github.event.inputs.release_notes }}"

          # Capture both HTTP status code and response body
          HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "X-API-Key: ${{ secrets.APP_HOSTING_API_KEY }}" \
            -F "apk=@app/build/outputs/apk/release/app-release-signed.apk" \
            -F "packageName=com.kroslabs.recipemanager" \
            -F "appName=Recipe Manager" \
            -F "versionName=${{ steps.new_version.outputs.new_version }}" \
            -F "versionCode=${{ steps.new_version.outputs.new_version_code }}" \
            -F "releaseNotes=$NOTES" \
            ${{ secrets.APP_HOSTING_URL }}/api/upload)

          # Extract status code (last line) and body (everything else)
          HTTP_STATUS=$(echo "$HTTP_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$HTTP_RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_STATUS"
          echo "Response: $RESPONSE_BODY"

          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "Upload successful!"
          else
            echo "Upload failed with status $HTTP_STATUS"
            exit 1
          fi

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Commit and tag version bump
        run: |
          git add app/build.gradle.kts
          git commit -m "Bump version to ${{ steps.new_version.outputs.new_version }}"
          git tag -a "v${{ steps.new_version.outputs.new_version }}" -m "Release v${{ steps.new_version.outputs.new_version }}"
          git push origin main --tags

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-v${{ steps.new_version.outputs.new_version }}
          path: app/build/outputs/apk/release/app-release-signed.apk
